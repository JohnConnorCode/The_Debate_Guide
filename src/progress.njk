---
layout: base.njk
title: "Your Progress — The Debate Guide"
description: "Track your quiz progress, view achievements, and see which chapters are due for review."
permalink: /progress/
---
{% block styles %}
<link rel="stylesheet" href="{{ '/css/chapter.css' | url }}">
<link rel="stylesheet" href="{{ '/css/quiz.css' | url }}">
<style>
/* Progress Dashboard Styles */
.progress-dashboard {
    max-width: var(--max-w-content);
    margin: 0 auto;
    padding: var(--space-lg);
}

.progress-help-link {
    text-align: center;
    margin-bottom: var(--space-lg);
}

.progress-help-link a {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-sm);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    color: var(--text-muted);
    text-decoration: none;
    border: 1px solid rgba(var(--color-white-rgb), 0.15);
    border-radius: var(--radius-sm);
    transition: all 0.2s ease-out;
}

[data-theme="light"] .progress-help-link a {
    border-color: rgba(var(--color-black-rgb), 0.15);
}

.progress-help-link a:hover {
    color: var(--accent);
    border-color: var(--accent);
    background: rgba(var(--color-gold-rgb), 0.05);
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
}

.stat-card {
    background: rgba(var(--color-white-rgb), 0.03);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-md);
    text-align: center;
}

[data-theme="light"] .stat-card {
    background: rgba(var(--color-black-rgb), 0.02);
    border-color: rgba(var(--color-black-rgb), 0.1);
}

.stat-value {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    color: var(--accent);
    line-height: 1;
    margin-bottom: var(--space-2);
}

.stat-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--text-muted);
}

/* Section Headers */
.progress-section {
    margin-bottom: var(--space-xl);
}

.progress-section-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    padding-bottom: var(--space-xs);
    border-bottom: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
}

[data-theme="light"] .progress-section-header {
    border-color: rgba(var(--color-black-rgb), 0.1);
}

.progress-section-header h2 {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    letter-spacing: var(--tracking-wider);
    margin: 0;
}

.progress-section-header .badge {
    padding: var(--space-1) var(--space-2);
    background: var(--accent);
    color: var(--color-ink);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    border-radius: var(--radius-full);
}

/* Achievements */
.achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-md);
}

.achievement-card {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: rgba(var(--color-white-rgb), 0.03);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-md);
    transition: all var(--transition-fast);
}

.achievement-card.unlocked {
    border-color: var(--accent);
    background: rgba(var(--color-gold-rgb), 0.05);
}

.achievement-card.locked {
    opacity: 0.5;
}

.achievement-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-white-rgb), 0.05);
    border-radius: var(--radius-md);
    font-size: var(--text-2xl);
}

.achievement-card.unlocked .achievement-icon {
    background: rgba(var(--color-gold-rgb), 0.2);
}

.achievement-info h3 {
    font-family: var(--font-display);
    font-size: var(--text-base);
    letter-spacing: var(--tracking-wide);
    margin: 0 0 var(--space-1) 0;
}

.achievement-info p {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--text-muted);
    margin: 0;
}

.achievement-date {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--accent);
    margin-top: var(--space-1);
}

/* Chapter Progress */
.chapter-progress-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.chapter-progress-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-sm) var(--space-md);
    background: rgba(var(--color-white-rgb), 0.03);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--transition-fast);
}

[data-theme="light"] .chapter-progress-item {
    background: rgba(var(--color-black-rgb), 0.02);
    border-color: rgba(var(--color-black-rgb), 0.1);
}

.chapter-progress-item:hover {
    border-color: var(--accent);
    background: rgba(var(--color-gold-rgb), 0.05);
}

.chapter-progress-item.mastered {
    border-left: 3px solid #2d7a4f;
}

.chapter-progress-item.completed {
    border-left: 3px solid var(--accent);
}

.chapter-progress-item.not-started {
    opacity: 0.6;
}

.chapter-number {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(var(--color-white-rgb), 0.1);
    border-radius: 50%;
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    font-weight: var(--font-bold);
    color: var(--text-muted);
}

.chapter-progress-item.mastered .chapter-number {
    background: #2d7a4f;
    color: white;
}

.chapter-progress-item.completed .chapter-number {
    background: var(--accent);
    color: var(--color-ink);
}

.chapter-info {
    flex: 1;
}

.chapter-info h3 {
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: var(--font-medium);
    margin: 0;
    color: var(--text-primary);
}

.chapter-meta {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-muted);
}

.chapter-score {
    flex-shrink: 0;
    font-family: var(--font-display);
    font-size: var(--text-xl);
    color: var(--accent);
}

.chapter-progress-item.mastered .chapter-score {
    color: #2d7a4f;
}

/* Due Reviews */
.due-reviews-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.due-review-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-md);
    background: rgba(var(--color-gold-rgb), 0.05);
    border: var(--border-width) solid rgba(var(--color-gold-rgb), 0.2);
    border-radius: var(--radius-md);
}

.due-review-info {
    flex: 1;
}

.due-review-info h3 {
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: var(--font-medium);
    margin: 0;
}

.due-review-info p {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-muted);
    margin: var(--space-1) 0 0 0;
}

.due-review-action .quiz-btn {
    padding: var(--space-2) var(--space-sm);
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-muted);
}

.empty-state-icon {
    font-size: var(--text-4xl);
    margin-bottom: var(--space-sm);
    opacity: 0.5;
}

.empty-state p {
    font-family: var(--font-body);
    font-size: var(--text-base);
    margin: 0;
}

/* Data Management */
.data-management {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: rgba(var(--color-white-rgb), 0.02);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-md);
    margin-top: var(--space-xl);
}

[data-theme="light"] .data-management {
    background: rgba(var(--color-black-rgb), 0.02);
    border-color: rgba(var(--color-black-rgb), 0.1);
}

.data-management-title {
    width: 100%;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    letter-spacing: var(--tracking-caps);
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: var(--space-xs);
}

.data-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-sm);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: transparent;
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.2);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    cursor: pointer;
    transition: all var(--transition-fast);
}

[data-theme="light"] .data-btn {
    border-color: rgba(var(--color-black-rgb), 0.2);
}

.data-btn:hover {
    border-color: var(--accent);
    background: rgba(var(--color-gold-rgb), 0.1);
}

.data-btn.danger {
    color: #e57373;
    border-color: rgba(229, 115, 115, 0.3);
}

.data-btn.danger:hover {
    background: rgba(229, 115, 115, 0.1);
    border-color: #e57373;
}

.data-btn svg {
    width: 16px;
    height: 16px;
}

#import-file {
    display: none;
}

/* Streak Display */
.streak-display {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-sm) var(--space-md);
    background: linear-gradient(135deg, rgba(var(--color-gold-rgb), 0.1), rgba(var(--color-gold-rgb), 0.05));
    border: var(--border-width) solid rgba(var(--color-gold-rgb), 0.3);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
}

.streak-icon {
    font-size: var(--text-2xl);
}

.streak-info {
    flex: 1;
}

.streak-info strong {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--accent);
}

.streak-info span {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-muted);
    display: block;
}

/* Responsive */
@media (max-width: 600px) {
    .progress-dashboard {
        padding: var(--space-md);
    }

    .progress-stats {
        grid-template-columns: repeat(2, 1fr);
    }

    .stat-value {
        font-size: var(--text-3xl);
    }

    .chapter-progress-item {
        flex-wrap: wrap;
    }

    .chapter-score {
        width: 100%;
        text-align: right;
        margin-top: var(--space-xs);
    }
}
</style>
{% endblock %}

{# Page Hero #}
<section class="chapter-hero section-dark">
    {% include "sunburst.njk" %}
    <p class="chapter-part">Your Learning Journey</p>
    <div class="chapter-number" style="opacity: 0.05;">&#9670;</div>
    <h1 class="chapter-title">PROGRESS</h1>
    <p class="chapter-subtitle">Track your mastery of rhetoric</p>
</section>

<div class="deco-border"></div>

<main class="section section-dark">
    <div class="progress-dashboard">

        {# How It Works Link #}
        <div class="progress-help-link">
            <a href="{{ '/how-quizzes-work/' | url }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                <span>How does this work?</span>
            </a>
        </div>

        {# Stats Overview #}
        <div class="progress-stats" id="progress-stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-completed">0</div>
                <div class="stat-label">Chapters Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-mastered">0</div>
                <div class="stat-label">Chapters Mastered</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-questions">0</div>
                <div class="stat-label">Questions Answered</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-average">—</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>

        {# Streak Display #}
        <div class="streak-display" id="streak-display" style="display: none;">
            <span class="streak-icon">&#128293;</span>
            <div class="streak-info">
                <strong id="streak-count">0</strong> day streak
                <span>Keep it going!</span>
            </div>
        </div>

        {# Due Reviews #}
        <section class="progress-section" id="due-reviews-section" style="display: none;">
            <div class="progress-section-header">
                <h2>Due for Review</h2>
                <span class="badge" id="due-count">0</span>
            </div>
            <div class="due-reviews-list" id="due-reviews-list">
                {# Populated by JavaScript #}
            </div>
        </section>

        {# Achievements #}
        <section class="progress-section">
            <div class="progress-section-header">
                <h2>Achievements</h2>
                <span class="badge" id="achievements-count">0/6</span>
            </div>
            <div class="achievements-grid" id="achievements-grid">
                {# Populated by JavaScript #}
            </div>
        </section>

        {# Chapter Progress #}
        <section class="progress-section">
            <div class="progress-section-header">
                <h2>Chapter Progress</h2>
            </div>
            <div class="chapter-progress-list" id="chapter-progress-list">
                {# Populated by JavaScript #}
            </div>
        </section>

        {# Data Management #}
        <div class="data-management">
            <div class="data-management-title">Data Management</div>
            <button class="data-btn" id="export-data-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export Data
            </button>
            <button class="data-btn" id="import-data-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Import Data
            </button>
            <input type="file" id="import-file" accept=".json">
            <button class="data-btn danger" id="reset-data-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Reset All Data
            </button>
        </div>

    </div>
</main>

<div class="deco-border"></div>

{% block scripts %}
<script>
(function() {
    'use strict';

    // Chapter data - must match chapters.json slugs and titles
    const chapters = [
        { id: 1, title: "Why Debate Matters", slug: "why-debate-matters", partNum: 1, part: "Part I" },
        { id: 2, title: "The Greek Legacy", slug: "the-greek-legacy", partNum: 1, part: "Part I" },
        { id: 3, title: "The Rhetorical Triangle", slug: "the-rhetorical-triangle", partNum: 1, part: "Part I" },
        { id: 4, title: "Kairos", slug: "kairos", partNum: 1, part: "Part I" },
        { id: 5, title: "Ethos: Building Credibility", slug: "ethos", partNum: 2, part: "Part II" },
        { id: 6, title: "Character in Action", slug: "character-in-action", partNum: 2, part: "Part II" },
        { id: 7, title: "Pathos: Moving Hearts", slug: "pathos", partNum: 2, part: "Part II" },
        { id: 8, title: "The Emotions Catalog", slug: "the-emotions-catalog", partNum: 2, part: "Part II" },
        { id: 9, title: "Logos: Constructing Reason", slug: "logos", partNum: 2, part: "Part II" },
        { id: 10, title: "Evidence and Proof", slug: "evidence-and-proof", partNum: 2, part: "Part II" },
        { id: 11, title: "Building Your Case", slug: "building-your-case", partNum: 3, part: "Part III" },
        { id: 12, title: "The Art of Refutation", slug: "the-art-of-refutation", partNum: 3, part: "Part III" },
        { id: 13, title: "Fallacies and Traps", slug: "fallacies-and-traps", partNum: 3, part: "Part III" },
        { id: 14, title: "The Socratic Method", slug: "the-socratic-method", partNum: 3, part: "Part III" },
        { id: 15, title: "Steelmanning", slug: "steelmanning", partNum: 3, part: "Part III" },
        { id: 16, title: "Debate in the Workplace", slug: "debate-in-the-workplace", partNum: 4, part: "Part IV" },
        { id: 17, title: "Debate in Education", slug: "debate-in-education", partNum: 4, part: "Part IV" },
        { id: 18, title: "Digital Discourse", slug: "digital-discourse", partNum: 4, part: "Part IV" },
        { id: 19, title: "Debate as Civic Duty", slug: "debate-as-civic-duty", partNum: 4, part: "Part IV" },
        { id: 20, title: "The Philosopher's Victory", slug: "the-philosophers-victory", partNum: 5, part: "Part V" }
    ];

    // Achievement definitions
    const achievementDefs = [
        { id: 'first-steps', title: 'First Steps', desc: 'Complete your first quiz', icon: '&#127942;' },
        { id: 'perfect-score', title: 'Perfect Score', desc: 'Score 100% on any quiz', icon: '&#11088;' },
        { id: 'scholar', title: 'Scholar', desc: 'Master 10 chapters (90%+ twice)', icon: '&#128218;' },
        { id: 'philosopher', title: 'Philosopher', desc: 'Master all 20 chapters', icon: '&#129504;' },
        { id: 'streak-master', title: 'Streak Master', desc: 'Maintain a 7-day study streak', icon: '&#128293;' }
    ];

    // Get data from quiz system
    const progress = window.DebateGuideQuiz ? window.DebateGuideQuiz.getProgress() : {};
    const achievements = window.DebateGuideQuiz ? window.DebateGuideQuiz.getAchievements() : { unlocked: [], stats: {} };
    const dueReviews = window.DebateGuideQuiz ? window.DebateGuideQuiz.getDueReviews() : [];

    // Calculate stats
    let completedCount = 0;
    let masteredCount = 0;
    let totalQuestions = 0;
    let totalScore = 0;
    let attemptedCount = 0;

    for (const [chapterId, data] of Object.entries(progress)) {
        completedCount++;
        totalQuestions += data.total * data.attempts;
        totalScore += data.percentage;
        attemptedCount++;

        if (data.percentage >= 90 && data.attempts >= 2) {
            masteredCount++;
        }
    }

    const averageScore = attemptedCount > 0 ? Math.round(totalScore / attemptedCount) : null;

    // Update stats display
    document.getElementById('stat-completed').textContent = completedCount;
    document.getElementById('stat-mastered').textContent = masteredCount;
    document.getElementById('stat-questions').textContent = totalQuestions;
    document.getElementById('stat-average').textContent = averageScore !== null ? averageScore + '%' : '—';

    // Show streak if active
    if (achievements.stats && achievements.stats.currentStreak > 0) {
        const streakDisplay = document.getElementById('streak-display');
        const streakCount = document.getElementById('streak-count');
        streakDisplay.style.display = 'flex';
        streakCount.textContent = achievements.stats.currentStreak;
    }

    // Render due reviews
    if (dueReviews.length > 0) {
        const section = document.getElementById('due-reviews-section');
        const list = document.getElementById('due-reviews-list');
        const count = document.getElementById('due-count');

        section.style.display = 'block';
        count.textContent = dueReviews.length;

        dueReviews.forEach(review => {
            const chapter = chapters.find(c => c.id === parseInt(review.chapterId));
            if (!chapter) return;

            const paddedId = String(chapter.id).padStart(2, '0');
            const item = document.createElement('div');
            item.className = 'due-review-item';
            item.innerHTML = `
                <div class="due-review-info">
                    <h3>Chapter ${chapter.id}: ${chapter.title}</h3>
                    <p>Due for review based on spaced repetition</p>
                </div>
                <div class="due-review-action">
                    <a href="/chapters/part-${chapter.partNum}/chapter-${paddedId}-${chapter.slug}/#chapter-quiz" class="quiz-btn quiz-btn-primary">
                        Review Now
                    </a>
                </div>
            `;
            list.appendChild(item);
        });
    }

    // Render achievements
    const achievementsGrid = document.getElementById('achievements-grid');
    const unlockedCount = achievements.unlocked ? achievements.unlocked.length : 0;
    document.getElementById('achievements-count').textContent = `${unlockedCount}/${achievementDefs.length}`;

    achievementDefs.forEach(def => {
        const isUnlocked = achievements.unlocked && achievements.unlocked.includes(def.id);
        const unlockedAt = isUnlocked && achievements.stats[def.id]
            ? new Date(achievements.stats[def.id].unlockedAt).toLocaleDateString()
            : null;

        const card = document.createElement('div');
        card.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
        card.innerHTML = `
            <div class="achievement-icon">${def.icon}</div>
            <div class="achievement-info">
                <h3>${def.title}</h3>
                <p>${def.desc}</p>
                ${unlockedAt ? `<div class="achievement-date">Unlocked ${unlockedAt}</div>` : ''}
            </div>
        `;
        achievementsGrid.appendChild(card);
    });

    // Render chapter progress
    const chapterList = document.getElementById('chapter-progress-list');

    chapters.forEach(chapter => {
        const data = progress[chapter.id];
        const paddedId = String(chapter.id).padStart(2, '0');

        let status = 'not-started';
        let scoreText = '—';

        if (data) {
            if (data.percentage >= 90 && data.attempts >= 2) {
                status = 'mastered';
            } else if (data.percentage >= 70) {
                status = 'completed';
            } else {
                status = 'attempted';
            }
            scoreText = data.percentage + '%';
        }

        const item = document.createElement('a');
        item.href = `/chapters/part-${chapter.partNum}/chapter-${paddedId}-${chapter.slug}/`;
        item.className = `chapter-progress-item ${status}`;
        item.innerHTML = `
            <div class="chapter-number">${chapter.id}</div>
            <div class="chapter-info">
                <h3>${chapter.title}</h3>
                <div class="chapter-meta">
                    ${chapter.part}
                    ${data ? ` • ${data.attempts} attempt${data.attempts !== 1 ? 's' : ''}` : ' • Not started'}
                </div>
            </div>
            <div class="chapter-score">${scoreText}</div>
        `;
        chapterList.appendChild(item);
    });

    // Show empty state if no progress
    if (completedCount === 0) {
        chapterList.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">&#128214;</div>
                <p>You haven't completed any quizzes yet.<br>Start with Chapter 1 to begin tracking your progress!</p>
            </div>
        `;
    }

    // ==========================================
    // DATA MANAGEMENT FUNCTIONS
    // ==========================================

    const STORAGE_KEYS = {
        progress: 'debateGuideQuizProgress',
        achievements: 'debateGuideAchievements',
        spacedRep: 'debateGuideSpacedRep',
        userId: 'debateGuideUserId'
    };

    // Export all user data
    document.getElementById('export-data-btn').addEventListener('click', () => {
        try {
            const exportData = {
                exportedAt: new Date().toISOString(),
                version: 1,
                userId: localStorage.getItem(STORAGE_KEYS.userId) || null,
                progress: JSON.parse(localStorage.getItem(STORAGE_KEYS.progress) || '{}'),
                achievements: JSON.parse(localStorage.getItem(STORAGE_KEYS.achievements) || '{}'),
                spacedRepetition: JSON.parse(localStorage.getItem(STORAGE_KEYS.spacedRep) || '{}')
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debate-guide-progress-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Data exported successfully!', 'success');
        } catch (e) {
            console.error('Export failed:', e);
            showToast('Export failed. Please try again.', 'error');
        }
    });

    // Import data
    const importInput = document.getElementById('import-file');
    document.getElementById('import-data-btn').addEventListener('click', () => {
        importInput.click();
    });

    importInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const importData = JSON.parse(event.target.result);

                // Validate structure
                if (!importData.version || !importData.progress) {
                    throw new Error('Invalid file format');
                }

                // Confirm before overwriting
                if (!confirm('This will merge imported data with your existing progress. Continue?')) {
                    return;
                }

                // Merge progress (keep best scores)
                const existingProgress = JSON.parse(localStorage.getItem(STORAGE_KEYS.progress) || '{}');
                for (const [chapterId, data] of Object.entries(importData.progress)) {
                    const existing = existingProgress[chapterId];
                    if (!existing || data.percentage > existing.percentage) {
                        existingProgress[chapterId] = data;
                    }
                }
                localStorage.setItem(STORAGE_KEYS.progress, JSON.stringify(existingProgress));

                // Merge achievements (union of unlocked)
                const existingAchievements = JSON.parse(localStorage.getItem(STORAGE_KEYS.achievements) || '{"unlocked":[],"stats":{}}');
                if (importData.achievements?.unlocked) {
                    const allUnlocked = new Set([
                        ...(existingAchievements.unlocked || []),
                        ...importData.achievements.unlocked
                    ]);
                    existingAchievements.unlocked = [...allUnlocked];
                    existingAchievements.stats = { ...existingAchievements.stats, ...(importData.achievements.stats || {}) };
                }
                localStorage.setItem(STORAGE_KEYS.achievements, JSON.stringify(existingAchievements));

                // Merge spaced repetition
                if (importData.spacedRepetition) {
                    const existingSR = JSON.parse(localStorage.getItem(STORAGE_KEYS.spacedRep) || '{}');
                    localStorage.setItem(STORAGE_KEYS.spacedRep, JSON.stringify({ ...existingSR, ...importData.spacedRepetition }));
                }

                showToast('Data imported successfully! Refreshing...', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } catch (err) {
                console.error('Import failed:', err);
                showToast('Import failed: Invalid file format', 'error');
            }
        };
        reader.readAsText(file);
        importInput.value = ''; // Reset for re-import
    });

    // Reset all data
    document.getElementById('reset-data-btn').addEventListener('click', () => {
        if (!confirm('Are you sure you want to delete ALL your progress? This cannot be undone.')) {
            return;
        }
        if (!confirm('This will permanently delete your quiz scores, achievements, and streaks. Are you absolutely sure?')) {
            return;
        }

        try {
            Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
            showToast('All data has been reset. Refreshing...', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } catch (e) {
            console.error('Reset failed:', e);
            showToast('Reset failed. Please try again.', 'error');
        }
    });

    // Toast helper
    function showToast(message, type = 'info') {
        // Use the global toast if available, otherwise fallback to alert
        if (window.showToast) {
            window.showToast(message, type);
        } else {
            // Simple fallback toast
            const toast = document.createElement('div');
            toast.className = 'simple-toast ' + type;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#333'};
                color: white;
                border-radius: 8px;
                font-family: var(--font-mono);
                font-size: 14px;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    }
})();
</script>
{% endblock %}
