---
layout: base.njk
title: "Admin Dashboard — The Debate Guide"
description: "View quiz analytics, user progress, and wrong answer patterns."
permalink: /admin/
---
{% block styles %}
<link rel="stylesheet" href="{{ '/css/chapter.css' | url }}?v={{ build.timestamp }}">
<style>
/* Admin Dashboard Styles */
.admin-login {
    max-width: 400px;
    margin: 4rem auto;
    padding: var(--space-xl);
    background: rgba(var(--color-white-rgb), 0.03);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-lg);
}

.admin-login h2 {
    font-family: var(--font-display);
    margin: 0 0 var(--space-md) 0;
    text-align: center;
}

.admin-login input {
    width: 100%;
    padding: var(--space-sm);
    font-size: var(--text-base);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.2);
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--text-primary);
    margin-bottom: var(--space-md);
}

.admin-login button {
    width: 100%;
    padding: var(--space-sm);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: var(--accent);
    color: var(--color-ink);
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: opacity var(--transition-fast);
}

.admin-login button:hover {
    opacity: 0.9;
}

.admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-lg);
    display: none;
}

.admin-dashboard.active {
    display: block;
}

/* Stats Cards */
.admin-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-xl);
}

.admin-stat-card {
    background: rgba(var(--color-white-rgb), 0.03);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    text-align: center;
}

.admin-stat-value {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    color: var(--accent);
    line-height: 1;
}

.admin-stat-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-muted);
    text-transform: uppercase;
    margin-top: var(--space-2);
}

/* Tabs */
.admin-tabs {
    display: flex;
    gap: var(--space-2);
    border-bottom: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    margin-bottom: var(--space-lg);
}

.admin-tab {
    padding: var(--space-sm) var(--space-md);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    transition: all var(--transition-fast);
}

.admin-tab:hover {
    color: var(--text-primary);
}

.admin-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

/* Tab Panels */
.admin-panel {
    display: none;
}

.admin-panel.active {
    display: block;
}

/* Tables */
.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
}

.admin-table th,
.admin-table td {
    padding: var(--space-sm);
    text-align: left;
    border-bottom: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
}

.admin-table th {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: var(--tracking-caps);
    color: var(--text-muted);
    background: rgba(var(--color-white-rgb), 0.02);
}

.admin-table tr:hover {
    background: rgba(var(--color-white-rgb), 0.02);
}

.admin-table .score {
    font-family: var(--font-mono);
}

.admin-table .score.pass {
    color: #4caf50;
}

.admin-table .score.fail {
    color: #f44336;
}

/* Progress Bar */
.progress-bar {
    height: 6px;
    background: rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%;
    background: var(--accent);
    transition: width var(--transition-normal);
}

/* Export Buttons */
.admin-actions {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.admin-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-sm);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    background: transparent;
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.2);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    cursor: pointer;
    text-decoration: none;
    transition: all var(--transition-fast);
}

.admin-btn:hover {
    border-color: var(--accent);
    background: rgba(var(--color-gold-rgb), 0.1);
}

/* Loading */
.admin-loading {
    text-align: center;
    padding: var(--space-xl);
    color: var(--text-muted);
}

.admin-loading::after {
    content: '';
    display: block;
    width: 32px;
    height: 32px;
    margin: var(--space-md) auto 0;
    border: 2px solid var(--accent);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Error Card */
.admin-error {
    background: rgba(244, 67, 54, 0.1);
    border: var(--border-width) solid rgba(244, 67, 54, 0.3);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    color: #f44336;
    text-align: center;
}

/* Wrong Answer Pattern */
.pattern-card {
    background: rgba(var(--color-white-rgb), 0.02);
    border: var(--border-width) solid rgba(var(--color-white-rgb), 0.1);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
}

.pattern-question {
    font-size: var(--text-sm);
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
}

.pattern-meta {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--text-muted);
}

.pattern-answers {
    display: flex;
    gap: var(--space-md);
    margin-top: var(--space-xs);
    font-size: var(--text-sm);
}

.pattern-wrong {
    color: #f44336;
}

.pattern-correct {
    color: #4caf50;
}

/* Responsive */
@media (max-width: 768px) {
    .admin-stats {
        grid-template-columns: repeat(2, 1fr);
    }

    .admin-table {
        font-size: var(--text-xs);
    }

    .admin-table th,
    .admin-table td {
        padding: var(--space-xs);
    }

    .admin-tabs {
        overflow-x: auto;
    }
}
</style>
{% endblock %}

{# Page Hero #}
<section class="chapter-hero section-dark">
    {% include "sunburst.njk" %}
    <p class="chapter-part">Administrator</p>
    <div class="chapter-number" style="opacity: 0.05;">&#9881;</div>
    <h1 class="chapter-title">DASHBOARD</h1>
    <p class="chapter-subtitle">Quiz Analytics & User Progress</p>
</section>

<div class="deco-border"></div>

<section class="section section-dark">
    {# Login Form #}
    <div class="admin-login" id="admin-login">
        <h2>Admin Access</h2>
        <input type="password" id="admin-password" placeholder="Enter admin password" autocomplete="current-password">
        <button id="admin-login-btn">Login</button>
        <p id="login-error" style="color: #f44336; text-align: center; margin-top: var(--space-sm); display: none;">
            Invalid password
        </p>
    </div>

    {# Dashboard (hidden until login) #}
    <div class="admin-dashboard" id="admin-dashboard">

        {# Stats Overview #}
        <div class="admin-stats" id="admin-stats">
            <div class="admin-stat-card">
                <div class="admin-stat-value" id="stat-users">—</div>
                <div class="admin-stat-label">Total Users</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-value" id="stat-attempts">—</div>
                <div class="admin-stat-label">Quiz Attempts</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-value" id="stat-avg-score">—</div>
                <div class="admin-stat-label">Average Score</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-value" id="stat-pass-rate">—</div>
                <div class="admin-stat-label">Pass Rate</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-value" id="stat-24h">—</div>
                <div class="admin-stat-label">Last 24 Hours</div>
            </div>
            <div class="admin-stat-card">
                <div class="admin-stat-value" id="stat-7d">—</div>
                <div class="admin-stat-label">Last 7 Days</div>
            </div>
        </div>

        {# Tabs #}
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="chapters">Chapters</button>
            <button class="admin-tab" data-tab="users">Users</button>
            <button class="admin-tab" data-tab="questions">Questions</button>
            <button class="admin-tab" data-tab="activity">Activity</button>
            <button class="admin-tab" data-tab="export">Export</button>
        </div>

        {# Chapters Panel #}
        <div class="admin-panel active" id="panel-chapters">
            <div class="admin-loading" id="chapters-loading">Loading chapter data...</div>
            <table class="admin-table" id="chapters-table" style="display: none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Chapter</th>
                        <th>Attempts</th>
                        <th>Users</th>
                        <th>Avg Score</th>
                        <th>Pass Rate</th>
                    </tr>
                </thead>
                <tbody id="chapters-tbody"></tbody>
            </table>
        </div>

        {# Users Panel #}
        <div class="admin-panel" id="panel-users">
            <div class="admin-loading" id="users-loading">Loading user data...</div>
            <div id="users-list-view" style="display: none;">
                <table class="admin-table" id="users-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Attempts</th>
                            <th>Passed</th>
                            <th>Mastered</th>
                            <th>Avg Score</th>
                            <th>Last Active</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="users-tbody"></tbody>
                </table>
            </div>
            <div id="user-detail-view" style="display: none;">
                <button class="admin-btn" id="user-back-btn" style="margin-bottom: var(--space-md);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Users
                </button>
                <div id="user-detail-content"></div>
            </div>
        </div>

        {# Questions Panel #}
        <div class="admin-panel" id="panel-questions">
            <div class="admin-loading" id="questions-loading">Loading question analytics...</div>
            <div id="questions-content" style="display: none;">
                <h3 style="margin-bottom: var(--space-md);">Hardest Questions</h3>
                <div id="hardest-questions"></div>

                <h3 style="margin: var(--space-lg) 0 var(--space-md);">Common Wrong Answers</h3>
                <div id="wrong-patterns"></div>
            </div>
        </div>

        {# Activity Panel #}
        <div class="admin-panel" id="panel-activity">
            <div class="admin-loading" id="activity-loading">Loading recent activity...</div>
            <table class="admin-table" id="activity-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>User</th>
                        <th>Chapter</th>
                        <th>Score</th>
                        <th>Hints</th>
                    </tr>
                </thead>
                <tbody id="activity-tbody"></tbody>
            </table>
        </div>

        {# Export Panel #}
        <div class="admin-panel" id="panel-export">
            <h3 style="margin-bottom: var(--space-md);">Export Data</h3>
            <div class="admin-actions">
                <a href="#" class="admin-btn" id="export-attempts">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    All Attempts (CSV)
                </a>
                <a href="#" class="admin-btn" id="export-users">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    All Users (CSV)
                </a>
                <a href="#" class="admin-btn" id="export-questions">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Question Responses (CSV)
                </a>
            </div>

            <h3 style="margin: var(--space-lg) 0 var(--space-md);">Export by Chapter</h3>
            <select id="export-chapter-select" style="padding: var(--space-sm); margin-right: var(--space-sm); background: transparent; color: var(--text-primary); border: var(--border-width) solid rgba(var(--color-white-rgb), 0.2); border-radius: var(--radius-sm);">
                <option value="">Select chapter...</option>
                {% for i in range(1, 21) %}
                <option value="{{ i }}">Chapter {{ i }}</option>
                {% endfor %}
            </select>
            <a href="#" class="admin-btn" id="export-chapter-btn">Export Chapter Data</a>
        </div>
    </div>
</section>

<div class="deco-border"></div>

{% block scripts %}
<script>
(function() {
    'use strict';

    const STORAGE_KEY = 'debateGuideAdminAuth';
    let adminPassword = '';

    // DOM Elements
    const loginForm = document.getElementById('admin-login');
    const dashboard = document.getElementById('admin-dashboard');
    const passwordInput = document.getElementById('admin-password');
    const loginBtn = document.getElementById('admin-login-btn');
    const loginError = document.getElementById('login-error');

    // Check stored auth
    const storedAuth = sessionStorage.getItem(STORAGE_KEY);
    if (storedAuth) {
        adminPassword = storedAuth;
        showDashboard();
    }

    // Login handler
    loginBtn.addEventListener('click', async () => {
        const password = passwordInput.value;
        if (!password) return;

        loginBtn.textContent = 'Verifying...';
        loginBtn.disabled = true;

        // Test auth with stats endpoint
        try {
            const res = await fetch('/api/admin/stats', {
                headers: { 'X-Admin-Password': password }
            });

            if (res.ok) {
                adminPassword = password;
                sessionStorage.setItem(STORAGE_KEY, password);
                showDashboard();
            } else {
                loginError.style.display = 'block';
            }
        } catch (err) {
            loginError.textContent = 'Connection error. Try again.';
            loginError.style.display = 'block';
        }

        loginBtn.textContent = 'Login';
        loginBtn.disabled = false;
    });

    passwordInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') loginBtn.click();
    });

    // Tab switching
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));

            tab.classList.add('active');
            document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
        });
    });

    async function showDashboard() {
        loginForm.style.display = 'none';
        dashboard.classList.add('active');

        // Load all data
        loadStats();
        loadChapters();
        loadUsers();
        loadQuestions();
        loadActivity();
        setupExport();
    }

    async function fetchWithAuth(url) {
        const res = await fetch(url, {
            headers: { 'X-Admin-Password': adminPassword }
        });
        if (!res.ok) throw new Error('Failed to fetch');
        return res.json();
    }

    async function loadStats() {
        try {
            const data = await fetchWithAuth('/api/admin/stats');
            const stats = data.stats;

            document.getElementById('stat-users').textContent = stats.total_users || 0;
            document.getElementById('stat-attempts').textContent = stats.total_attempts || 0;
            document.getElementById('stat-avg-score').textContent = stats.average_score ? stats.average_score + '%' : '—';
            document.getElementById('stat-pass-rate').textContent = stats.pass_rate ? stats.pass_rate + '%' : '—';
            document.getElementById('stat-24h').textContent = stats.last_24h_attempts || 0;
            document.getElementById('stat-7d').textContent = stats.last_7d_attempts || 0;
        } catch (err) {
            console.error('Failed to load stats:', err);
        }
    }

    async function loadChapters() {
        try {
            const data = await fetchWithAuth('/api/admin/chapters');
            const tbody = document.getElementById('chapters-tbody');
            tbody.innerHTML = '';

            data.chapters.forEach(ch => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${ch.chapter_number}</td>
                    <td>${ch.title}</td>
                    <td>${ch.attempts || 0}</td>
                    <td>${ch.unique_users || 0}</td>
                    <td class="score ${ch.avg_score >= 70 ? 'pass' : 'fail'}">${ch.avg_score !== null ? ch.avg_score + '%' : '—'}</td>
                    <td>${ch.pass_rate !== null ? ch.pass_rate + '%' : '—'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('chapters-loading').style.display = 'none';
            document.getElementById('chapters-table').style.display = 'table';
        } catch (err) {
            document.getElementById('chapters-loading').innerHTML = '<div class="admin-error">Failed to load chapter data</div>';
        }
    }

    async function loadQuestions() {
        try {
            const data = await fetchWithAuth('/api/admin/questions');
            const hardestEl = document.getElementById('hardest-questions');
            const patternsEl = document.getElementById('wrong-patterns');

            // Render hardest questions
            hardestEl.innerHTML = (data.hardestQuestions || []).slice(0, 10).map(q => `
                <div class="pattern-card">
                    <div class="pattern-question">Ch ${q.chapter_number}, Q${q.question_index + 1}: ${q.question_text || '(No text)'}</div>
                    <div class="pattern-meta">
                        ${q.total_responses} responses • ${q.error_rate}% error rate • ${q.avg_hints_used} avg hints
                    </div>
                    <div class="progress-bar" style="margin-top: var(--space-xs);">
                        <div class="progress-bar-fill" style="width: ${q.error_rate}%; background: #f44336;"></div>
                    </div>
                </div>
            `).join('');

            // Render wrong patterns
            patternsEl.innerHTML = (data.wrongAnswerPatterns || []).slice(0, 10).map(p => `
                <div class="pattern-card">
                    <div class="pattern-question">Ch ${p.chapter_number}, Q${p.question_index + 1}: ${p.question_text || '(No text)'}</div>
                    <div class="pattern-answers">
                        <span class="pattern-wrong">Wrong: ${p.user_answer}</span>
                        <span class="pattern-correct">Correct: ${p.correct_answer}</span>
                    </div>
                    <div class="pattern-meta">${p.frequency} occurrences</div>
                </div>
            `).join('');

            document.getElementById('questions-loading').style.display = 'none';
            document.getElementById('questions-content').style.display = 'block';
        } catch (err) {
            document.getElementById('questions-loading').innerHTML = '<div class="admin-error">Failed to load question analytics</div>';
        }
    }

    async function loadActivity() {
        try {
            const data = await fetchWithAuth('/api/admin/activity');
            const tbody = document.getElementById('activity-tbody');
            tbody.innerHTML = '';

            (data.activity || []).forEach(a => {
                const time = new Date(a.completed_at).toLocaleString();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${time}</td>
                    <td style="font-family: var(--font-mono); font-size: var(--text-xs);">${a.anonymous_id.substring(0, 8)}...</td>
                    <td>Ch ${a.chapter_number}</td>
                    <td class="score ${a.percentage >= 70 ? 'pass' : 'fail'}">${a.score}/${a.total_questions} (${a.percentage}%)</td>
                    <td>${a.hints_used}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('activity-loading').style.display = 'none';
            document.getElementById('activity-table').style.display = 'table';
        } catch (err) {
            document.getElementById('activity-loading').innerHTML = '<div class="admin-error">Failed to load activity</div>';
        }
    }

    async function loadUsers() {
        try {
            const data = await fetchWithAuth('/api/admin/users');
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';

            (data.users || []).forEach(u => {
                const lastActive = u.last_seen_at ? new Date(u.last_seen_at).toLocaleDateString() : '—';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.email || '<span style="color: var(--text-muted);">' + u.anonymous_id.substring(0, 12) + '...</span>'}</td>
                    <td>${u.attempts || 0}</td>
                    <td>${u.chaptersPassed || 0}/20</td>
                    <td>${u.chaptersMastered || 0}/20</td>
                    <td class="score ${u.avgScore >= 70 ? 'pass' : 'fail'}">${u.avgScore !== null ? u.avgScore + '%' : '—'}</td>
                    <td>${lastActive}</td>
                    <td><button class="admin-btn view-user-btn" data-user-id="${u.id}">View</button></td>
                `;
                tbody.appendChild(tr);
            });

            // Setup view buttons
            document.querySelectorAll('.view-user-btn').forEach(btn => {
                btn.addEventListener('click', () => showUserDetail(btn.dataset.userId));
            });

            document.getElementById('users-loading').style.display = 'none';
            document.getElementById('users-list-view').style.display = 'block';
        } catch (err) {
            document.getElementById('users-loading').innerHTML = '<div class="admin-error">Failed to load user data</div>';
        }
    }

    async function showUserDetail(userId) {
        const listView = document.getElementById('users-list-view');
        const detailView = document.getElementById('user-detail-view');
        const content = document.getElementById('user-detail-content');

        listView.style.display = 'none';
        detailView.style.display = 'block';
        content.innerHTML = '<div class="admin-loading">Loading user details...</div>';

        try {
            const data = await fetchWithAuth(`/api/admin/users?userId=${userId}`);
            const user = data.user;
            const attempts = data.attempts || [];

            content.innerHTML = `
                <div class="pattern-card" style="margin-bottom: var(--space-lg);">
                    <h3 style="color: var(--accent); margin-bottom: var(--space-sm);">${user.email || 'Anonymous User'}</h3>
                    <div class="pattern-meta" style="margin-bottom: var(--space-md);">
                        ID: ${user.anonymous_id}<br>
                        Joined: ${new Date(user.created_at).toLocaleDateString()}<br>
                        Last active: ${user.last_seen_at ? new Date(user.last_seen_at).toLocaleString() : 'Never'}
                    </div>
                    <div class="admin-stats" style="margin: 0;">
                        <div class="admin-stat-card">
                            <div class="admin-stat-value">${user.stats.totalAttempts}</div>
                            <div class="admin-stat-label">Attempts</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value">${user.stats.chaptersPassed}/20</div>
                            <div class="admin-stat-label">Passed</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value">${user.stats.chaptersMastered}/20</div>
                            <div class="admin-stat-label">Mastered</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value">${user.stats.averageScore}%</div>
                            <div class="admin-stat-label">Avg Score</div>
                        </div>
                    </div>
                </div>

                <h4 style="margin-bottom: var(--space-sm);">Quiz History</h4>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Chapter</th>
                            <th>Score</th>
                            <th>Hints</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${attempts.map(a => `
                            <tr>
                                <td>${new Date(a.completed_at).toLocaleString()}</td>
                                <td>Chapter ${a.chapter_number}</td>
                                <td class="score ${a.percentage >= 70 ? 'pass' : 'fail'}">${a.score}/${a.total_questions} (${a.percentage}%)</td>
                                <td>${a.hints_used}</td>
                                <td>${a.time_taken_seconds ? Math.round(a.time_taken_seconds / 60) + ' min' : '—'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (err) {
            content.innerHTML = '<div class="admin-error">Failed to load user details</div>';
        }

        // Setup back button
        document.getElementById('user-back-btn').addEventListener('click', () => {
            detailView.style.display = 'none';
            listView.style.display = 'block';
        });
    }

    function setupExport() {
        const baseUrl = '/api/admin/export';

        document.getElementById('export-attempts').href = `${baseUrl}?type=attempts&password=${adminPassword}`;
        document.getElementById('export-users').href = `${baseUrl}?type=users&password=${adminPassword}`;
        document.getElementById('export-questions').href = `${baseUrl}?type=questions&password=${adminPassword}`;

        document.getElementById('export-chapter-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const ch = document.getElementById('export-chapter-select').value;
            if (!ch) {
                alert('Select a chapter first');
                return;
            }
            window.location.href = `${baseUrl}?type=attempts&chapter=${ch}&password=${adminPassword}`;
        });
    }
})();
</script>
{% endblock %}
